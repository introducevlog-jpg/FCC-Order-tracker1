<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F.C.Consumers Sales Tracker</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --danger: #dc2626;
            --success: #16a34a;
        }

        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* HEADER */
        header {
            background: var(--primary);
            color: var(--white);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20;
            position: relative;
        }
        .app-logo { max-height: 40px; border-radius: 5px; margin-right: 10px; background: #fff; }
        .header-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; }
        
        /* MENUS */
        .menu-btn { font-size: 1.5rem; cursor: pointer; padding: 0 10px; }
        .dropdown-menu {
            position: absolute;
            top: 50px; right: 10px;
            background: white;
            color: black;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            min-width: 150px;
            z-index: 100;
        }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        
        /* LAYOUT */
        .page { display: none; flex-direction: column; height: 100vh; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg); }
        .active { display: flex; }
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }

        /* CARDS & INPUTS */
        .card { background: var(--white); padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #4b5563; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; margin-bottom: 10px; }
        
        /* PRODUCT GRID */
        .product-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; align-items: end; margin-bottom: 10px; }
        .product-title { grid-column: 1 / -1; font-weight: bold; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 5px; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-add { background: #4b5563; padding: 8px; font-size: 0.9rem; margin-top: 5px; }
        
        /* LISTS */
        .list-item { background: #f8fafc; padding: 8px; border: 1px solid #e2e8f0; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; font-size: 0.9rem; }
        
        /* OWNER STYLES */
        .sale-card { background: white; border-left: 5px solid var(--primary); padding: 10px; margin-bottom: 10px; font-size: 0.9rem; border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sale-head { display: flex; justify-content: space-between; font-weight: bold; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .total { text-align: right; font-weight: bold; color: var(--success); font-size: 1.1rem; margin-top: 5px; }
        
        /* TAB BAR */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 50;
        }
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active-tab {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .summary-table th { background-color: #f2f2f2; color: var(--primary); }
        
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="employeePage" class="page active">
        <header>
            <div class="header-title">
                <img id="headerLogo" src="" class="app-logo" style="display:none;">
                <span>Sales Entry</span>
            </div>
            <div style="position:relative;">
                <span class="menu-btn" onclick="window.toggleEmpMenu()">&#8942;</span>
                <div id="empMenu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="window.navTo('ownerLoginPage')">Owner Mode</div>
                </div>
            </div>
        </header>

        <div class="content">
            <div class="card">
                <label>Employee Name</label>
                <input type="text" id="emp_name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <label>Shop Name</label>
                <input type="text" id="shop_name" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <label>Shop Address</label>
                <input type="text" id="shop_address" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ">
            </div>

            <div class="card">
                <h3>Fixed Products</h3>
                <div class="product-title">1. Vixol</div>
                <div class="product-row">
                    <input type="text" id="vixol_size" placeholder="Size (ML)">
                    <input type="number" id="vixol_pcs" placeholder="Qty">
                    <input type="number" id="vixol_rate" placeholder="Rate">
                </div>
                <div class="product-title">2. TC</div>
                <div class="product-row">
                    <input type="text" id="tc_size" placeholder="Size (ML)">
                    <input type="number" id="tc_pcs" placeholder="Qty">
                    <input type="number" id="tc_rate" placeholder="Rate">
                </div>
                <div class="product-title">3. Detergent</div>
                <div class="product-row">
                    <input type="text" id="det_size" placeholder="Size (GM)">
                    <input type="number" id="det_pcs" placeholder="Qty">
                    <input type="number" id="det_rate" placeholder="Rate">
                </div>
                 <div class="product-title">4. Damp Crash</div>
                 <div class="product-row">
                     <input type="text" id="damp_size" placeholder="Size (ML)">
                     <input type="number" id="damp_pcs" placeholder="Qty">
                     <input type="number" id="damp_rate" placeholder="Rate">
                 </div>
            </div>

            <div class="card">
                <h3>Add New Products</h3>
                <input type="text" id="new_name" placeholder="Product Name">
                <div class="product-row">
                    <input type="text" id="new_size" placeholder="Size">
                    <input type="number" id="new_pcs" placeholder="Qty">
                    <input type="number" id="new_total" placeholder="Total Price">
                </div>
                <button class="btn btn-add" onclick="window.addNewProduct()">+ Add Product</button>
                <div id="newProdList"></div>
            </div>

            <div class="card">
                <h3>Notepad</h3>
                <textarea id="sales_note" rows="3" placeholder="‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
            </div>

            <button id="submitBtn" class="btn btn-success" onclick="window.submitSales()">SUBMIT ORDER</button>
        </div>
    </div>

    <div id="ownerLoginPage" class="page">
        <header>
            <span onclick="window.navTo('employeePage')" style="cursor:pointer;">&#8592; Back</span>
            Owner Login
        </header>
        <div class="content" style="display:flex; flex-direction:column; justify-content:center;">
            <div class="card">
                <label>Password</label>
                <input type="password" id="ownerPass">
                <button class="btn btn-primary" onclick="window.verifyOwner()">Login</button>
            </div>
        </div>
    </div>

    <div id="ownerDashboard" class="page">
        <header>
            <span>Admin Panel</span>
            <div style="position:relative;">
                <span class="menu-btn" onclick="window.toggleOwnerMenu()">&#8942;</span>
                <div id="ownerMenu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="window.toggleSMode()">Toggle 'S' Mode</div>
                    <div class="dropdown-item" onclick="window.ownerLogout()">Logout</div>
                </div>
            </div>
        </header>

        <div class="content" style="padding-bottom: 80px;">
            <div id="tabOrders">
                <div class="card">
                    <label>Settings</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="logoUrlInput" placeholder="Logo URL" style="margin:0;">
                        <button class="btn-add" style="margin:0; width:auto;" onclick="window.saveLogo()">Save</button>
                    </div>
                </div>
                <div id="salesHistory">Loading Data...</div>
                <button class="btn btn-danger" onclick="window.resetData()" style="margin-top:30px;">Reset All Data</button>
            </div>

            <div id="tabSummary" class="hidden">
                <div class="card">
                    <h3>Sales Summary</h3>
                    <div id="summaryContent">Loading...</div>
                </div>
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab-btn active-tab" onclick="window.switchTab('orders')">All Orders</div>
            <div class="tab-btn" onclick="window.switchTab('summary')">Summary</div>
        </div>
    </div>

    <script type="module">
        // 1. Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. YOUR FIREBASE CONFIGURATION
        const firebaseConfig = {
          apiKey: "AIzaSyAcm3y_38P31He35XJSq0yQaQLo-NNd2Os",
          authDomain: "fcc-selas-tracker.firebaseapp.com",
          projectId: "fcc-selas-tracker",
          storageBucket: "fcc-selas-tracker.firebasestorage.app",
          messagingSenderId: "385841221324",
          appId: "1:385841221324:web:55919f8a0bb260cc6f3c69",
          measurementId: "G-LFJLK166XT"
        };

        // 3. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const SALES_COLLECTION = "sales_records";

        // --- GLOBAL VARIABLES ---
        const PASS = "NAZRUL";
        let newProducts = [];
        let isSMode = false;
        let globalSalesData = []; // Store data from Firebase locally for rendering

        // --- INIT ---
        window.onload = function() {
            loadLogo();
            
            // --- FIX IS HERE ---
            // ‡¶Ü‡¶ó‡ßá 'orderBy' ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶è‡¶∞‡¶∞ ‡¶π‡¶ö‡ßç‡¶õ‡¶ø‡¶≤‡•§ ‡¶è‡¶ñ‡¶® ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶®‡ßá JS ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
            const q = collection(db, SALES_COLLECTION); 
            
            onSnapshot(q, (snapshot) => {
                globalSalesData = [];
                snapshot.forEach((doc) => {
                    globalSalesData.push({ ...doc.data(), docId: doc.id });
                });

                // Client-side Sorting (‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá)
                globalSalesData.sort((a, b) => b.id - a.id);

                renderDashboard();
                renderSummary();
            }, (error) => {
                console.error("Error getting documents: ", error);
                document.getElementById('salesHistory').innerText = "Error loading data: " + error.message;
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('menu-btn')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
                }
            });
        };

        // --- GLOBAL FUNCTIONS (Attached to Window) ---
        
        window.navTo = function(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        window.toggleEmpMenu = function() { document.getElementById('empMenu').classList.toggle('show'); }
        window.toggleOwnerMenu = function() { document.getElementById('ownerMenu').classList.toggle('show'); }

        window.addNewProduct = function() {
            const name = document.getElementById('new_name').value;
            const size = document.getElementById('new_size').value || '-';
            const pcs = document.getElementById('new_pcs').value;
            const total = parseFloat(document.getElementById('new_total').value);

            if(!name || !pcs || isNaN(total)) { alert("Invalid Input"); return; }

            newProducts.push({ name, size, pcs, total });
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `<span>${name} (${size}) x ${pcs}</span> <b>${total} Tk</b>`;
            document.getElementById('newProdList').appendChild(div);
            
            document.getElementById('new_name').value = '';
            document.getElementById('new_size').value = '';
            document.getElementById('new_pcs').value = '';
            document.getElementById('new_total').value = '';
        }

        window.submitSales = async function() {
            const emp = document.getElementById('emp_name').value;
            if(!emp) { alert("Employee Name Required!"); return; }

            const btn = document.getElementById('submitBtn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                const getF = (id, name) => ({
                    name, 
                    size: document.getElementById(id+'_size').value,
                    pcs: parseFloat(document.getElementById(id+'_pcs').value)||0,
                    rate: parseFloat(document.getElementById(id+'_rate').value)||0
                });
                
                const fixedItems = [
                    getF('vixol','Vixol'), getF('tc','TC'), 
                    getF('det','Detergent'), getF('damp','Damp Crash')
                ].map(i => ({...i, total: i.pcs*i.rate})).filter(i => i.pcs>0);

                let grandTotal = 0;
                fixedItems.forEach(i => grandTotal += i.total);
                newProducts.forEach(i => grandTotal += i.total);

                const record = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    emp, 
                    shop: document.getElementById('shop_name').value,
                    addr: document.getElementById('shop_address').value,
                    note: document.getElementById('sales_note').value,
                    fixedItems, newItems: newProducts, grandTotal
                };

                // Save to Firestore
                await addDoc(collection(db, SALES_COLLECTION), record);

                alert("Order Submitted Successfully to Database!");
                resetForm();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Error saving: " + e.message);
            }
            
            btn.innerText = "SUBMIT ORDER";
            btn.disabled = false;
        }

        function resetForm() {
            const inputs = document.querySelectorAll('#employeePage input, #employeePage textarea');
            inputs.forEach(i => i.value = '');
            newProducts = [];
            document.getElementById('newProdList').innerHTML = '';
            window.scrollTo(0,0);
        }

        window.verifyOwner = function() {
            if(document.getElementById('ownerPass').value === PASS) {
                sessionStorage.setItem('isOwner', 'true');
                document.getElementById('ownerPass').value = '';
                window.navTo('ownerDashboard');
            } else alert("Wrong Password");
        }

        window.ownerLogout = function() {
            sessionStorage.removeItem('isOwner');
            window.navTo('employeePage');
        }

        window.saveLogo = function() {
            const url = document.getElementById('logoUrlInput').value;
            if(url) { localStorage.setItem('app_logo', url); loadLogo(); alert("Saved!"); }
        }

        function loadLogo() {
            const url = localStorage.getItem('app_logo');
            if(url) { document.getElementById('headerLogo').src = url; document.getElementById('headerLogo').style.display='block'; }
        }

        window.toggleSMode = function() {
            isSMode = !isSMode;
            renderDashboard();
            alert("S Mode: " + (isSMode ? "ON" : "OFF"));
        }

        window.switchTab = function(tab) {
            const ordersDiv = document.getElementById('tabOrders');
            const summaryDiv = document.getElementById('tabSummary');
            const btns = document.querySelectorAll('.tab-btn');

            if(tab === 'orders') {
                ordersDiv.classList.remove('hidden');
                summaryDiv.classList.add('hidden');
                btns[0].classList.add('active-tab');
                btns[1].classList.remove('active-tab');
                renderDashboard();
            } else {
                ordersDiv.classList.add('hidden');
                summaryDiv.classList.remove('hidden');
                btns[0].classList.remove('active-tab');
                btns[1].classList.add('active-tab');
                renderSummary();
            }
        }

        function renderDashboard() {
            const container = document.getElementById('salesHistory');
            container.innerHTML = '';

            if(globalSalesData.length === 0) { container.innerHTML = '<p align="center">No Data Found</p>'; return; }

            globalSalesData.forEach(sale => {
                let detailsHTML = sale.fixedItems.map(i => 
                    `<div class="detail-row"><span>${i.name} (${i.size}) [${i.pcs}x${i.rate}]</span><span>${i.total}</span></div>`
                ).join('');

                if(sale.newItems && sale.newItems.length) {
                    detailsHTML += '<div style="border-top:1px dashed #ccc; margin:5px 0"></div>';
                    detailsHTML += sale.newItems.map(i => 
                        `<div class="detail-row"><span>+ ${i.name} (${i.size}) x${i.pcs}</span><span>${i.total}</span></div>`
                    ).join('');
                }

                const head = isSMode ? "Record" : sale.emp;
                const shop = sale.shop ? `Shop: ${sale.shop}` : '';
                
                container.innerHTML += `
                    <div class="sale-card">
                        <div class="sale-head"><span>${head}</span><small>${sale.date.split(',')[0]}</small></div>
                        <div style="color:#666;font-size:0.8rem;">${shop}</div>
                        <div style="margin-top:5px;">${detailsHTML}</div>
                        ${!isSMode && sale.note ? `<div style="background:#fffbeb;padding:5px;margin-top:5px;">üìù ${sale.note}</div>` : ''}
                        <div class="total">Total: ${sale.grandTotal} Tk</div>
                    </div>`;
            });
        }

        function renderSummary() {
            let prodMap = {};
            let totalRev = 0;

            globalSalesData.forEach(sale => {
                totalRev += sale.grandTotal;
                const add = (name, qty, money) => {
                    if(!prodMap[name]) prodMap[name] = { pcs: 0, money: 0 };
                    prodMap[name].pcs += parseFloat(qty);
                    prodMap[name].money += parseFloat(money);
                };
                
                if(sale.fixedItems) sale.fixedItems.forEach(i => add(i.name, i.pcs, i.total));
                if(sale.newItems) sale.newItems.forEach(i => add(i.name, i.pcs, i.total));
            });

            let rows = '';
            for(let p in prodMap) {
                rows += `<tr><td>${p}</td><td>${prodMap[p].pcs}</td><td>${prodMap[p].money}</td></tr>`;
            }

            document.getElementById('summaryContent').innerHTML = `
                <div style="font-size:1.2rem; font-weight:bold; color:green; text-align:center; padding:10px; background:#e8f5e9; border-radius:5px; margin-bottom:15px;">
                    TOTAL REVENUE: ${totalRev} Tk
                </div>
                <table class="summary-table">
                    <thead><tr><th>Product</th><th>Total Qty</th><th>Total Tk</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        window.resetData = async function() {
            if(confirm("WARNING: This will delete ALL data from the database permanently! Are you sure?")) {
                // Delete documents one by one
                const snapshot = await getDocs(collection(db, SALES_COLLECTION));
                snapshot.forEach(async (d) => {
                    await deleteDoc(doc(db, SALES_COLLECTION, d.id));
                });
                alert("Database Reset Complete.");
            }
        }

    </script>
</body>
</html>